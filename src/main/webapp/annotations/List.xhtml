<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:a="http://xmlns.jcp.org/jsf/passthrough" xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:p="http://primefaces.org/ui">

<ui:composition>
    <h:outputStylesheet library="css" name="xray.css" />
    <h:outputScript library="js" name="xray-header.js" />
    <style>
        html,
        body {
            background-color: white !important;
        }

        .map {
            height: 460px;
            width: auto;
        }

        .button-interface {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .button-interface>button {
            height: 40px;
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }

        .button-interface>button:last-of-type {
            width: 100%;
        }

        #left {
            padding: .5em 0 0 .5em;
        }
    </style>

    <div class="ui-g">
        <div id="left" class="ui-g-7">
            <div id="teeth-map" class="ui-g-6">
                <h:form id="AnnotationsCreateMapForm">
                    <p:selectBooleanButton id="selectAll" value="#{annotationsDentalXrayController.isSelectAll}"
                        onLabel="Unselect" offLabel="Select All"
                        rendered="#{studiesController.studyDate.equals(annotationsDentalXrayController.todaysDate)}">
                        <p:ajax listener="#{annotationsDentalXrayController.selectDeselectTeeth}"
                            update="AnnotationsListForm annotationCreateFull" />
                    </p:selectBooleanButton>

                    <h:panelGroup class="ui-g-12" style="display: flex; justify-content: center;">
                        <!--render if specie is feline-->
                        <h:graphicImage usemap="#catTeethMap" name="images/maps/catTeethRed.png" class="responsive map"
                            rendered="#{petPatientsController.selected.specieId.id eq 2}" />
                        <!--render if specie is canine or equine-->
                        <h:graphicImage usemap="#dogTeethMap" name="images/maps/DogTeethChart2.png"
                            class="responsive map"
                            rendered="#{petPatientsController.selected.specieId.id eq 1 or petPatientsController.selected.specieId.id eq 3 }" />

                        <h:panelGroup id="catChart" rendered="#{petPatientsController.selected.specieId.id eq 2}">
                            <ui:include src="/teethCharts/Cat.xhtml" />
                        </h:panelGroup>
                        <h:panelGroup id="dogChart"
                            rendered="#{petPatientsController.selected.specieId.id eq 1 or petPatientsController.selected.specieId.id eq 3 }">
                            <ui:include src="/teethCharts/Dog.xhtml" />
                        </h:panelGroup>
                    </h:panelGroup>


                    <h:panelGroup id="xrayActionButtons" class="xrayActionButtonsStyle"
                        rendered="#{studiesController.studyDate.equals(annotationsDentalXrayController.todaysDate) }">
                        <!--renders only when working with EZ Sensor-->
                        <p:commandButton class="btn xray_btn" id="onEZXray" value="Start" widgetVar="startSensor"
                            rendered="#{!annotationsDentalXrayController.isOnXray and !annotationsDentalXrayController.isHDRSensor}"
                            onclick="startProgressBar(); this.disabled = true;" style="width: 100%">
                            <p:ajax listener="#{annotationsDentalXrayController.startWaitingForRadiation()}"
                                update=":growl, AnnotationsListForm, xrayActionButtons, onEZXray, offEZXray, @(.pollStyle)" />
                        </p:commandButton>
                        <p:commandButton class="btn xray_btn xray_stop_btn" id="offEZXray" value="Ready"
                            rendered="#{annotationsDentalXrayController.isOnXray and !annotationsDentalXrayController.isHDRSensor and annotationsDentalXrayController.currentValue lt 2}"
                            onclick="PF('pbAjax').cancel();" style="width: 100%">
                            <p:ajax listener="#{annotationsDentalXrayController.sensorKiller}"
                                update=":growl, AnnotationsListForm, xrayActionButtons, onEZXray, offEZXray, @(.pollStyle)" />
                        </p:commandButton>
                        <p:tooltip id="toolTipTrack" for="offEZXray" value="Stop Sensor Process" trackMouse="true" />
                    </h:panelGroup>
                </h:form>
            </div>

            <div style="padding-top: 0; padding-bottom: 0;" class="ui-g-6">
                <div class="annotation-area">
                    <h:form id="AnnotationsListForm">
                        <p:dataTable id="datalist" value="#{annotationsDentalXrayController.itemsToShow}" var="item"
                            selection="#{annotationsDentalXrayController.selected}" rowKey="#{item.id}"
                            selectionMode="single">

                            <p:ajax event="rowSelect" listener="#{annotationsDentalXrayController.startNextCurrent}" />
                            <p:ajax event="rowUnselect" />
                            <p:column>
                                <f:facet name="header">
                                    <!--<h:outputText value="{bundle.ListAnnotationsTitle_teethNumberId}" />-->
                                </f:facet>
                                <h:outputText
                                    value="#{item.teethNumberId.name} #{item.teethNumberId.number} #{item.teethNumberId.side}"
                                    style="font-size: 15px" />
                            </p:column>>
                        </p:dataTable>
                    </h:form>
                </div>

                <div class="ui-g-12 progress-bar">
                    <p:progressBar id="xrayProgressBar" widgetVar="pbAjax" ajax="true"
                        value="#{annotationsDentalXrayController.progressBar}" labelTemplate="{value}%" interval="2000"
                        styleClass="animated" global="false">
                        <p:ajax event="complete" listener="#{annotationsDentalXrayController.onComplete}"
                            update=":growl" oncomplete="PF('pbAjax').start()" />
                    </p:progressBar>
                </div>

                <div style="padding: 0;" class="ui-g-12">
                    <h:form id="MainInterfaceForm">
                        <div class="button-interface">
                            <p:commandButton id="addNewStudy" action="#{petPatientsController.addAndRedirectToXrayPage}"
                                value="Add Study"
                                rendered="#{!studiesController.studyDate.equals(annotationsDentalXrayController.todaysDate)}">
                                <p:tooltip value="#{bundle.AddToWorkList}" />
                                <p:confirm header="#{bundle.ConfirmationHeader}"
                                    message="#{bundle.ConfirmCreateStudy} #{petPatientsController.selected.name}"
                                    icon="pi pi-exclamation-triangle" />
                            </p:commandButton>

                            <p:commandButton action="#{annotationsDentalXrayController.preDestroy}" value="Work List"
                                update="@(.worklistStyle)" />
                            <p:commandButton action="#{annotationsDentalXrayController.redirectToStudyList()}"
                                value="Study List" update="@(.worklistStyle)" />
                            <p:commandButton id="openViewer" value="Open Viewer"
                                actionListener="#{annotationsDentalXrayController.stopSensorAndOpenViewer}"
                                update=" @(.pollStyle)">
                            </p:commandButton>
                            <p:commandButton  rendered="true" actionListener="#{annotationsDentalXrayController.simulateRadiation}" value="Simulate X-Ray" id="HDRSimulateButton"/>
                        </div>
                    </h:form>
                </div>

                <h:form id="XrayActionForm">
                    <!--renders only when working with HDR Sensor-->
                    <!--<p:commandButton value="HDR sensor start" actionListener="{annotationsDentalXrayController.launchStopSensorProgrammTest}"-->

                    <p:commandButton class="btn xray_btn" id="onHDRXray" value="Start" widgetVar="startSensor"
                        title="Click to wake the sensor up"
                        rendered="#{!annotationsDentalXrayController.isOnXray and annotationsDentalXrayController.isHDRSensor}"
                        onclick="startProgressBar(); this.disabled = true;" style="width: 100%">
                        <p:ajax listener="#{annotationsDentalXrayController.startWaitingForRadiation}"
                            update=":growl, AnnotationsListForm,  XrayActionForm @(.pollStyle)" />
                    </p:commandButton>
                    <p:commandButton class="btn xray_btn xray_stop_btn" id="offHDRXray" value="Ready"
                        title="Click to stop the sensor"
                        rendered="#{annotationsDentalXrayController.isOnXray and annotationsDentalXrayController.isHDRSensor and !(annotationsDentalXrayController.currentValue eq 2)}"
                        onclick="stopProgressBar(); this.disabled = true;" style="width: 100%">
                        <p:ajax listener="#{annotationsDentalXrayController.sensorKiller}"
                            update=":growl, AnnotationsListForm,  XrayActionForm @(.pollStyle)" />
                    </p:commandButton>
                    <!--                            <h:graphicImage 
                            rendered="#{annotationsDentalXrayController.isOnXray and annotationsDentalXrayController.isHDRSensor and (annotationsDentalXrayController.currentValue eq 2)}" 
                            name="images/Radiation_sign.png" class="loader"/>-->
                </h:form>
            </div>

            <!--This is the light gallery that is at the bottom of the x-ray page-->
            <div class="ui-g-12">
                <div class="viewer-labels">

                    <p:outputLabel value="#{petPatientsController.selected.name}"
                        style="font-size: 15px !important;text-align: center; color: grey;" />
                    <p:outputLabel value="#{studiesController.selected.creationDate}"
                        style="font-size: 15px  !important;text-align: center; color: grey;" />
                </div>
            </div>
        </div>

        <div class="ui-g-5">
            <div style="padding-top: 0;" class="ui-g-12">
                <h:panelGroup id="annotationCreateFull">
                    <ui:include src="Create.xhtml" />
                </h:panelGroup>
            </div>

            <div style="padding-top: 0; padding-left: 0;" class="ui-g-12">
                <h:panelGroup id="xrayBody">
                    <div a:class="thumbnailDicomContainer">
                        <div a:class="row xray-thumbnail-container" style='margin:0px !important;'>

                            <div class='col-lg-12 myGallery'>
                                <h:panelGroup id="thumbnailContainer" layout="block" class="row">
                                    <div class="demo-gallery ">
                                        <ul id="lightgallery" class="list-unstyled row">
                                        </ul>
                                    </div>
                                    <h:outputScript>
                                        setScrollHandler($("#lightgallery"));
                                    </h:outputScript>                                     
                                </h:panelGroup>
                            </div>
                        </div>

                        <!--                            <div class="col-lg-12 dicom-viewer">
                                <ui:include src="/imageAnnotationState/DicomViewer.xhtml"/>
                            </div>-->
                        <!--<ui:include src="animals.xhtml"/>-->
                    </div>
                </h:panelGroup>
            </div>
        </div>
    </div>
    <h:form id="xrayBottomThumbnail2" class="view-thumbnail" style="display: none !important;">

        <h:outputScript library="js" name="lightgallery-all.min.js" />
        <script>
            var interval1 = undefined;
            var interval2 = undefined;
            var onPageLoad = true;

            $(function () {
                interval2 = setInterval(prepViewer, 1500); // fast process: will load the images (gallery), once the page has redered the other components
                onPageLoad = true;

                onPageLoad = false;
                //prepViewer();
                console.log("Time until DOMready: ", Date.now() - timerStart);

                //                    
                $(document).on('click', '.thumbnail ', function () {
                    var imageInfo = $(this).attr('data-sub-html');
                    $('.image-info').html('<span style="font-size: 15px !important;">' + imageInfo + '</span>');
                    var imageSrc = $(this).find('.img-responsive').attr('src');

                    $("#currentImage").attr('src', imageSrc);
                    $("#currentImage").css('display', 'block');
                })
            });

            //starts the image acquisition progress bar on xray button click
            function startProgressBar() {
                PF('pbAjax').start();
            }

            function clearOutputFolder() {
                //{annotationsDentalXrayController.clearOutputFolder};
            }

            function loadImageIntoThumbnail(targetId, base64, imageId, toothName, dicomTags, divId) {
                let dataArray = [dicomTags.patientName, dicomTags.seriesDescription, dicomTags.patientSex, dicomTags.patientSpecie
                    , dicomTags.studyDescription, dicomTags.studyDate.replace(",", ""), dicomTags.acquisitionDate.replace(",", ""), dicomTags.patientBirthDate, dicomTags.patientId];
                console.log("Next Data Array...");
                console.log(dataArray);
                $('#' + targetId).append(' <div id="' + divId + '"  class="img-global-thumbnail"><input type="checkbox" class="select_image" name="select' + imageId + '" value="' + imageId + '"></input><img id="' + imageId + '" src="data:image/jpg;base64,' + base64 + '" data-tooth-name="' + toothName + '" data-tags="' + dataArray + '" alt="Cinque Terre" class="img-thumbnail" style="height: 95% !important;" onclick="imageClic(this)"></img></div>');
            }

            function loadLightGallery(base64, imageId, toothName, divId) {
                $("#lightgallery").append('<li id="' + divId + '"  class="thumbnail"   data-src="data:image/jpg;base64,' + base64 + '" data-sub-html="' + toothName + '"><img class="img-responsive" src="data:image/jpg;base64,' + base64 + '" ></img></li>');
            }

            function prepViewer() {
                console.log('on prep viewer...');
                let isViewerOpen = #{ annotationsDentalXrayController.isOpenViewer };
                //console.log(isViewerOpen);
                if (!isViewerOpen) {
                    let imageList = #{ viewerController.imagesAsJson };
                    //console.log(imageList);
                    $("#lightgallery").html(''); // fixes the image repetition issue on page refresh in the thumbnail component
                    $("#img-thumbnail").html(''); // fixes the image repetition issue on page refresh thumbnail component in the dicom viewer

                    let lastImage;
                    $.each(imageList, function (key, val) {
                        addImageToThumbnail(val);
                        lastImage = val;
                    });
                    if (lastImage !== undefined) {
                        $("#currentImage").attr('src', 'data:image/jpg;base64,' + lastImage.imageAsBase64);
                        $("#currentImage").css('display', 'block');
                    }



                }
                //                  
                console.log("Time Loading all images: ", Date.now() - timerStart);
                timerStart = 0;
                imageList = null;
                //console.log(imageList);
                console.log('sale..');
                if (!onPageLoad) {
                    clearInterval(interval1);
                }

                clearInterval(interval2);
            }

            function addImageToThumbnail(imageModel) {
                console.log("The imageModel:::::::::");
                console.log(imageModel);
                loadLightGallery(imageModel.imageAsBase64, imageModel.imageId, imageModel.toothName);
            }

            function asignSelectedImagesFromViewer() {
                console.log("calling the selected images function...")
                console.log(getSelectedImagesFromViewer());
            }
        </script>
    </h:form>
    <h:form id="xrayBottomThumbnail" class="view-thumbnail" style="display: none !important;">
        <script>
            // only call prepViewer() on an explicit call, because on page load this function is called with a delay interval in order to load the page fastly
            if (!onPageLoad) {
                console.log("explicit call to prepViewer...");
                interval1 = setInterval(prepViewer, 10); // fast process: will load the images (gallery), once the page has redered the other components

            } else {
                console.log("NOT explicit call to prepViewer beacuse is rendering the whole page...");
            }
        </script>
    </h:form>
    <h:form id="xrayBottomThumbnail3" class="view-thumbnail" style="display: none !important;">
        <script>
            if (!onPageLoad) {
                addImageToThumbnail();
            }
        </script>
    </h:form>

    <ui:include src="sensorCommunicationComponent/sensorCommunication.xhtml" />
</ui:composition>

</html>